name: Refresh UCD Store Manifest

on:
  schedule:
    - cron: "0 2 * * 1"
    - cron: "0 2 * * 4"

  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL to trigger manifest refresh'
        required: false
        type: choice
        options: &urls
          - 'https://api.ucdjs.dev'
          - 'https://preview.api.ucdjs.dev'

permissions: {}

jobs:
  refresh:
    name: Refresh Manifest (${{ matrix.base_url }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        base_url: *urls
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          cache: pnpm

      - name: install dependencies
        run: pnpm install --frozen-lockfile

      - name: generate manifest
        if: github.event_name == 'schedule' || matrix.base_url == inputs.base_url
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { default: generateManifest } = await import('${{ github.workspace }}/apps/api/scripts/generate-manifest.ts');

            await generateManifest({ outputDir: 'manifest-output' });

      - name: Create and upload version tar files
        if: github.event_name == 'schedule' || matrix.base_url == inputs.base_url
        run: |
          cd manifest-output

          # Upload each version directory as a tar file
          failed=0
          for version_dir in ucdjs-manifest-v*/; do
            if [ ! -d "$version_dir" ]; then
              continue
            fi

            dir_name=$(basename "$version_dir")
            tar_name="${dir_name}.tar"
            echo "Creating and uploading $tar_name..."

            # Create tar with the directory contents
            tar -cvf "$tar_name" -C "$version_dir" .

            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "X-UCDJS-Task-Key: ${{ secrets.TASK_API_KEY }}" \
              -H "Content-Type: application/x-tar" \
              --data-binary @"$tar_name" \
              "${{ matrix.base_url }}/_tasks/upload-manifest")

            status=$(echo "$response" | tail -1)
            if [ "$status" != "200" ]; then
              echo "Failed to upload $dir_name"
              body=$(echo "$response" | sed '$d')
              echo "Response: $body"
              failed=$((failed + 1))
            else
              echo "$dir_name uploaded successfully"
            fi

            # Small delay between uploads
            sleep 0.5
          done

          if [ $failed -gt 0 ]; then
            echo "$failed version(s) failed to upload"
            exit 1
          fi

          echo "All versions uploaded successfully"
