name: Refresh UCD Store Manifest

on:
  schedule:
    - cron: "0 2 * * 1"
    - cron: "0 2 * * 4"

  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: false
        type: choice
        options:
          - "prod"
          - "preview"

permissions: {}

jobs:
  refresh:
    name: Refresh Manifest (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: ${{ github.event_name == 'schedule' && fromJson('["prod", "preview"]') || (github.event.inputs.env && fromJson(format('["{0}"]', github.event.inputs.env)) || fromJson('["prod", "preview"]')) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          cache: pnpm

      - name: install dependencies
        run: pnpm install --frozen-lockfile

      - name: build ucdjs-scripts
        run: pnpm --filter @ucdjs/ucdjs-scripts build

      - name: install to symlink
        run: pnpm install --frozen-lockfile

      - name: refresh manifests
        env:
          UCDJS_TASK_KEY: ${{ secrets.TASK_API_KEY }}
          ENV: ${{ matrix.env }}
        run: |
          pnpm ucdjs-scripts refresh-manifests --env "$ENV"

      - name: purge cache
        env:
          BASE_URL: ${{ matrix.env == 'prod' && 'https://api.ucdjs.dev' || 'https://preview.api.ucdjs.dev' }}
          CACHE_NAME: ucdjs:well-known:ucd-store
          KEY: ${{ secrets.TASK_API_KEY }}
        run: |
          echo "Purging cache for versioned manifests..."
          purge_response=$(curl -s -w "\n%{http_code}" -G \
            -H "X-UCDJS-Task-Key: $KEY" \
            --data-urlencode "cacheName=$CACHE_NAME" \
            --data-urlencode "path=/.well-known/ucd-store" \
            "$BASE_URL/_tasks/purge-cache")

          purge_status=$(echo "$purge_response" | tail -1)
          if [ "$purge_status" = "200" ]; then
            echo "Cache purged successfully"
          else
            echo "Warning: Failed to purge cache (status: $purge_status)"
            purge_body=$(echo "$purge_response" | sed '$d')
            echo "Response: $purge_body"
          fi
