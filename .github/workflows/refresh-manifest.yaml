name: Refresh UCD Store Manifest

on:
  schedule:
    - cron: "0 2 * * 1"
    - cron: "0 2 * * 4"

  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL to trigger manifest refresh'
        required: false
        type: choice
        # NOTE: Keep in sync with matrix.base_url below
        options:
          - 'https://api.ucdjs.dev'
          - 'https://preview.api.ucdjs.dev'

permissions: {}

jobs:
  refresh:
    name: Refresh Manifest (${{ matrix.base_url }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # NOTE: Keep in sync with inputs.base_url.options above
        base_url: ${{ github.event_name == 'schedule' && fromJson('["https://api.ucdjs.dev", "https://preview.api.ucdjs.dev"]') || fromJson(format('["{0}"]', github.event.inputs.base_url)) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: lts/*
          cache: pnpm

      - name: install dependencies
        run: pnpm install --frozen-lockfile

      - name: generate manifest
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          BASE_URL: ${{ matrix.base_url }}
        with:
          script: |
            const { runGenerateManifest } = await import('${{ github.workspace }}/apps/api/scripts/generate-manifest.ts');

            await runGenerateManifest({ outputDir: 'manifest-output', apiBaseUrl: process.env.BASE_URL });

      - name: Fetch current store manifest
        id: fetch-store
        env:
          BASE_URL: ${{ matrix.base_url }}
        run: |
          echo "Fetching current store manifest from $BASE_URL..."
          curl -s "$BASE_URL/api/v1/files/.ucd-store.json" -o current-store.json || echo "{}" > current-store.json
          echo "Current store manifest fetched"

      - name: Create and upload version tar files
        env:
          BASE_URL: ${{ matrix.base_url }}
          CACHE_PATH: /api/v1/files/.ucd-store.json
          CACHE_NAME: ucdjs:v1_files:ucd-store
        run: |
          cd manifest-output

          # Upload each version directory as a tar file
          failed=0
          skipped=0
          uploaded=0
          uploaded_versions=""
          skipped_versions=""
          failed_versions=""

          for version_dir in ucdjs-manifest-v*/; do
            if [ ! -d "$version_dir" ]; then
              continue
            fi

            dir_name=$(basename "$version_dir")
            # Extract version from directory name (ucdjs-manifest-v16.0.0 -> 16.0.0)
            version="${dir_name#ucdjs-manifest-v}"

            echo "Processing version $version..."

            # Get local and remote JSON (normalized for comparison)
            local_json=$(jq -cS '.' "$version_dir/manifest.json")
            store_version_value=$(jq -r --arg v "$version" '.[$v] // empty' ../current-store.json)

            if [ -n "$store_version_value" ]; then
              remote_json=$(echo "$store_version_value" | jq -cS '.')
            else
              remote_json=""
            fi

            echo "Local JSON:  $local_json"
            echo "Remote JSON: $remote_json"

            # Calculate SHA256 checksums
            local_sha=$(echo "$local_json" | sha256sum | cut -d' ' -f1)
            if [ -n "$remote_json" ]; then
              remote_sha=$(echo "$remote_json" | sha256sum | cut -d' ' -f1)
            else
              remote_sha=""
            fi

            echo "Version $version: local=$local_sha remote=$remote_sha"

            # Compare checksums - skip if they match
            if [ "$local_sha" = "$remote_sha" ]; then
              echo "Skipping $version - no changes detected"
              skipped=$((skipped + 1))
              skipped_versions="$skipped_versions $version"
              continue
            fi

            tar_name="${dir_name}.tar"
            echo "Creating and uploading $tar_name..."

            # Create tar with the directory contents
            tar -cf "$tar_name" -C "$version_dir" .

            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "X-UCDJS-Task-Key: ${{ secrets.TASK_API_KEY }}" \
              -H "Content-Type: application/x-tar" \
              --data-binary @"$tar_name" \
              "$BASE_URL/_tasks/upload-manifest")

            status=$(echo "$response" | tail -1)
            if [ "$status" != "200" ]; then
              echo "Failed to upload $dir_name"
              body=$(echo "$response" | sed '$d')
              echo "Response: $body"
              failed=$((failed + 1))
              failed_versions="$failed_versions $version"
            else
              echo "$dir_name uploaded successfully"
              uploaded=$((uploaded + 1))
              uploaded_versions="$uploaded_versions $version"
            fi

            # Small delay between uploads
            sleep 0.5
          done

          echo ""
          echo "Summary: uploaded=$uploaded skipped=$skipped failed=$failed"

          # Purge cache only if there were uploads
          cache_purged="false"
          if [ $uploaded -gt 0 ]; then
            echo "Purging cache for .ucd-store.json..."
            purge_response=$(curl -s -w "\n%{http_code}" -G \
              -H "X-UCDJS-Task-Key: ${{ secrets.TASK_API_KEY }}" \
              --data-urlencode "cacheName=$CACHE_NAME" \
              --data-urlencode "path=$CACHE_PATH" \
              "$BASE_URL/_tasks/purge-cache")

            purge_status=$(echo "$purge_response" | tail -1)
            if [ "$purge_status" = "200" ]; then
              echo "Cache purged successfully"
              cache_purged="true"
            else
              echo "Warning: Failed to purge cache (status: $purge_status)"
              purge_body=$(echo "$purge_response" | sed '$d')
              echo "Response: $purge_body"
            fi
          fi

          # Write GitHub Actions Job Summary
          {
            echo "## Manifest Refresh Summary"
            echo ""
            echo "**Target:** \`$BASE_URL\`"
            echo ""
            echo "| Status | Count |"
            echo "|--------|-------|"
            echo "| ‚úÖ Uploaded | $uploaded |"
            echo "| ‚è≠Ô∏è Skipped (no changes) | $skipped |"
            echo "| ‚ùå Failed | $failed |"
            echo ""

            if [ $uploaded -gt 0 ]; then
              echo "### Uploaded Versions"
              echo ""
              if [ "$cache_purged" = "true" ]; then
                echo "> üîÑ Cache for \`$CACHE_PATH\` was purged"
              else
                echo "> ‚ö†Ô∏è Cache purge failed - changes may take up to 7 days to propagate"
              fi
              echo ""
              for v in $uploaded_versions; do
                echo "- \`$v\`"
              done
              echo ""
            fi

            if [ $skipped -gt 0 ]; then
              echo "<details>"
              echo "<summary>Skipped Versions ($skipped)</summary>"
              echo ""
              for v in $skipped_versions; do
                echo "- \`$v\`"
              done
              echo ""
              echo "</details>"
              echo ""
            fi

            if [ $failed -gt 0 ]; then
              echo "### ‚ùå Failed Versions"
              echo ""
              for v in $failed_versions; do
                echo "- \`$v\`"
              done
              echo ""
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          if [ $failed -gt 0 ]; then
            echo "$failed version(s) failed to upload"
            exit 1
          fi

          echo "All versions processed successfully"
