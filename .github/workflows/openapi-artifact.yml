name: openapi artifacts

on:
  pull_request:
    paths-ignore:
      - ".vscode/**"
      - "**/*.md"
      - ".github/ISSUE_TEMPLATE/**"

# automatically cancel older in-progress jobs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1
  FORCE_COLOR: true

permissions: {}

jobs:
  upload-openapi:
    name: upload openapi artifacts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - branch: main
            artifact: main
          - branch: ${{ github.head_ref }}
            artifact: pull-request

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          ref: ${{ matrix.branch }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: install dependencies
        run: pnpm install --frozen-lockfile

      - name: generate openapi artifact
        run: pnpm --filter=@ucdjs/api build:openapi

      - name: upload openapi schema to artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: openapi-${{ matrix.artifact }}
          path: ./ucd-generated/api/openapi.json
          if-no-files-found: error

  report-changes:
    name: report openapi schema changes
    needs: upload-openapi
    runs-on: ubuntu-latest
    if: github.repository == 'ucdjs/ucd'
    permissions:
      pull-requests: write
      statuses: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: download openapi artifacts (pull-request)
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: openapi-pull-request
          path: openapi-artifacts/pull-request

      - name: download openapi artifacts (main)
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: openapi-main
          path: openapi-artifacts/main

      - name: setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: setup node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: compare openapi schemas
        id: compare
        env:
          MAIN_SCHEMA_PATH: openapi-artifacts/main/openapi.json
          PR_SCHEMA_PATH: openapi-artifacts/pull-request/openapi.json
          OUTPUT_PATH: openapi-diff.md
        run: |
          node .github/scripts/compare-openapi.ts

      - name: find existing comment
        id: find-comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: <!-- ucdjs:openapi-artifacts -->


      - name: create or update comment
        id: create-comment
        if: steps.compare.outputs.has_changes == 'true' || steps.find-comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        env:
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: openapi-diff.md
          edit-mode: replace

      - name: add openapi diff to job summary
        run: |
          cat openapi-diff.md >> $GITHUB_STEP_SUMMARY

      - name: remove approval label on schema changes
        if: steps.compare.outputs.has_changes == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: 'approve-breaking-openapi'
              });
              console.log('Removed approve-breaking-openapi label due to schema changes');
            } catch (error) {
              if (error.status === 404) {
                console.log('approve-breaking-openapi label was not present');
              } else {
                console.log('Error removing label:', error.message);
              }
            }

      - name: create status check based on changes
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          HAS_CHANGES: ${{ steps.compare.outputs.has_changes }}
          HAS_BREAKING_CHANGES: ${{ steps.compare.outputs.has_breaking_changes }}
          ADDED_ENDPOINTS: ${{ steps.compare.outputs.added_endpoints }}
          REMOVED_ENDPOINTS: ${{ steps.compare.outputs.removed_endpoints }}
          MODIFIED_ENDPOINTS: ${{ steps.compare.outputs.modified_endpoints }}
          ADDED_COMPONENTS: ${{ steps.compare.outputs.added_components }}
          REMOVED_COMPONENTS: ${{ steps.compare.outputs.removed_components }}
          MODIFIED_COMPONENTS: ${{ steps.compare.outputs.modified_components }}
        with:
          script: |
            const hasChanges = process.env.HAS_CHANGES === 'true';
            const hasBreakingChanges = process.env.HAS_BREAKING_CHANGES === 'true';
            const addedEndpoints = parseInt(process.env.ADDED_ENDPOINTS);
            const removedEndpoints = parseInt(process.env.REMOVED_ENDPOINTS);
            const modifiedEndpoints = parseInt(process.env.MODIFIED_ENDPOINTS);
            const addedComponents = parseInt(process.env.ADDED_COMPONENTS);
            const removedComponents = parseInt(process.env.REMOVED_COMPONENTS);
            const modifiedComponents = parseInt(process.env.MODIFIED_COMPONENTS);

            let state, description;

            if (!hasChanges) {
              state = 'success';
              description = 'No OpenAPI schema changes detected';
            } else if (hasBreakingChanges) {
              state = 'failure';
              const breakingItems = [];
              if (removedEndpoints > 0) breakingItems.push(`${removedEndpoints} endpoint(s)`);
              if (removedComponents > 0) breakingItems.push(`${removedComponents} schema(s)`);
              description = `Breaking changes: removed ${breakingItems.join(' and ')}`;
            } else {
              state = 'success';
              const changes = [];
              if (addedEndpoints > 0) changes.push(`+${addedEndpoints} endpoint(s)`);
              if (addedComponents > 0) changes.push(`+${addedComponents} schema(s)`);
              if (modifiedEndpoints > 0) changes.push(`~${modifiedEndpoints} endpoint(s)`);
              if (modifiedComponents > 0) changes.push(`~${modifiedComponents} schema(s)`);
              description = `Non-breaking changes: ${changes.join(', ')}`;
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.HEAD_SHA,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'openapi-schema-check'
            });
