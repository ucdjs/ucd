name: deploy to preview

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: Run the workflow without creating a deployment
        required: false
        default: false
        type: boolean
      app:
        description: App to deploy (check ucdjs-apps.json for available apps, or use 'both' for all)
        required: false
        default: both
        type: string
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

# automatically cancel older in-progress jobs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}
  cancel-in-progress: true

# remove default permissions of GITHUB_TOKEN for security
# https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs
permissions: {}

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1
  FORCE_COLOR: true

jobs:
  upsert-deployment-comment:
    name: upsert deployment comment
    runs-on: ubuntu-latest
    if: github.repository == 'ucdjs/ucd' && github.event.pull_request.user.login == 'luxass'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: find existing comment
        id: find-comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: <!-- ucdjs:deployment:preview -->

      - name: generate initial comment table
        id: generate-table
        uses: ./.github/actions/manage-apps@ab73d3b0b9464581e286863734cad57d90206a98
        with:
          command: generate-comment-table
          dry-run: ${{ github.event.inputs.dry-run }}

      - name: create initial pr comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        env:
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          DRY_RUN: ${{ github.event.inputs.dry-run }}
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- ucdjs:deployment:preview -->
            ## üåè Preview Deployments

            ${{ env.DRY_RUN == 'true' && '**Note: This was a dry run - no actual deployments were created.**' || '' }}

            ${{ steps.generate-table.outputs.comment-table }}

            **Built from commit:** `${{ env.HEAD_SHA }}`

            ---
            <sub>ü§ñ This comment will be updated automatically when you push new commits to this PR.</sub>
          edit-mode: replace

  deploy:
    needs:
      - upsert-deployment-comment
    permissions:
      contents: read
      pull-requests: write
    uses: ./.github/workflows/deploy-app.yml
    with:
      environment: preview
      cloudflare-env: preview
      dry-run: ${{ github.event.inputs.dry-run == 'true' }}
      app: ${{ github.event.inputs.app || 'both' }}
      include-pr-comment: true
      repository-condition: ${{ github.repository == 'ucdjs/ucd' && github.event.pull_request.user.login == 'luxass' }}
      extra-build-step: true
    secrets:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

  update-deployment-comment:
    runs-on: ubuntu-latest
    needs:
      - upsert-deployment-comment
      - deploy
    if: always() && github.repository == 'ucdjs/ucd' && github.event.pull_request.user.login == 'luxass'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: download deployment results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          pattern: deployment-result-*

      - name: process deployment results
        id: process-results
        uses: ./.github/actions/manage-apps@ab73d3b0b9464581e286863734cad57d90206a98
        with:
          command: process-deployment-results
          deployment-results-path: .
          dry-run: ${{ github.event.inputs.dry-run }}

      - name: find existing comment
        id: find-comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: <!-- ucdjs:deployment:preview -->

      - name: create consolidated pr comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        env:
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          DRY_RUN: ${{ github.event.inputs.dry-run }}
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- ucdjs:deployment:preview -->
            ## üåè Preview Deployments

            ${{ env.DRY_RUN == 'true' && '**Note: This was a dry run - no actual deployments were created.**' || '' }}

            ${{ steps.process-results.outputs.comment-table }}

            **Built from commit:** `${{ env.HEAD_SHA }}`

            ---
            <sub>ü§ñ This comment will be updated automatically when you push new commits to this PR.</sub>
          edit-mode: replace
